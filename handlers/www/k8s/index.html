<!DOCTYPE html>
<html ng-app="DockerPlay" ng-controller="PlayController">
<head>
    <title>Kubernetes Playground</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a202c;
            color: white;
            height: 100vh;
            overflow: hidden;
        }

        .playground-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .playground-header {
            background: #2d3748;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #4a5568;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-left i {
            font-size: 24px;
            color: #4fc3f7;
        }

        .session-timer {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(0, 0, 0, 0.2);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
        }

        .header-right {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        .btn-primary {
            background: #4fc3f7;
            color: white;
        }

        .btn-primary:hover {
            background: #29b6f6;
        }

        .btn-outline {
            background: transparent;
            color: #cbd5e0;
            border: 1px solid #4a5568;
        }

        .btn-outline:hover {
            background: #4a5568;
            color: white;
        }

        .playground-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 250px;
            background: #2d3748;
            border-right: 1px solid #4a5568;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-section h3 {
            font-size: 14px;
            text-transform: uppercase;
            color: #a0aec0;
            margin-bottom: 15px;
            letter-spacing: 1px;
        }

        .instance-list {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .instance-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .instance-item:hover {
            background: #4a5568;
        }

        .instance-item.active {
            background: #4fc3f7;
            color: white;
        }

        .instance-status {
            margin-left: auto;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-indicator.running {
            background: #48bb78;
        }

        .resource-monitor {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .resource {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .resource label {
            font-size: 12px;
            color: #a0aec0;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #4a5568;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: #4fc3f7;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .resource-value {
            font-size: 11px;
            color: #a0aec0;
        }

        .terminal-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1a202c;
        }

        .terminal-header {
            background: #2d3748;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #4a5568;
        }

        .terminal-tabs {
            display: flex;
            gap: 5px;
        }

        .tab {
            padding: 5px 15px;
            background: #4a5568;
            border-radius: 4px 4px 0 0;
            font-size: 12px;
            cursor: pointer;
        }

        .tab.active {
            background: #1a202c;
            color: #4fc3f7;
        }

        .terminal-controls {
            display: flex;
            gap: 5px;
        }

        .control-btn {
            background: transparent;
            color: #a0aec0;
            border: none;
            padding: 5px;
            cursor: pointer;
            border-radius: 3px;
        }

        .control-btn:hover {
            background: #4a5568;
            color: white;
        }

        .terminal-body {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        .terminal-line {
            margin-bottom: 5px;
            white-space: pre-wrap;
        }

        .cursor {
            animation: blink 1s infinite;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .terminal-input {
            background: #2d3748;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-top: 1px solid #4a5568;
        }

        .prompt {
            color: #4fc3f7;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        #command-input {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            outline: none;
        }

        .playground-footer {
            background: #2d3748;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #4a5568;
            font-size: 12px;
        }

        .footer-info {
            color: #a0aec0;
        }

        .footer-actions {
            display: flex;
            gap: 10px;
        }

        /* Additional styles for Angular integration */
        [ng-cloak] {
            display: none !important;
        }

        .disconnected {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.87);
            z-index: 1000;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .upload-status {
            padding: 8px;
            background: #ffecb3;
            margin-bottom: 8px;
            color: #333;
            border-radius: 4px;
        }

        .instance-details {
            padding: 15px;
            background: #2d3748;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .detail-row {
            display: flex;
            margin-bottom: 10px;
            gap: 15px;
        }

        .detail-item {
            flex: 1;
        }

        .detail-item label {
            display: block;
            font-size: 12px;
            color: #a0aec0;
            margin-bottom: 5px;
        }

        .detail-item .value {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.2);
            padding: 8px;
            border-radius: 4px;
            word-break: break-all;
        }

        .port-chip {
            display: inline-block;
            background: #4a5568;
            padding: 4px 8px;
            border-radius: 4px;
            margin: 0 5px 5px 0;
            font-size: 12px;
        }

        .port-chip a {
            color: #4fc3f7;
            text-decoration: none;
        }

        .port-chip a:hover {
            text-decoration: underline;
        }
    </style>

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-89019737-3"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-89019737-3');
    </script>
</head>

<body ng-cloak>
    <div class="playground-container">
        <!-- Header -->
        <div class="playground-header">
            <div class="header-left">
                <i class="fas fa-cubes"></i>
                <h2>Kubernetes Playground</h2>
                <div class="session-timer">
                    <i class="fas fa-clock"></i>
                    <span>{{ttl}} hours remaining</span>
                </div>
            </div>
            <div class="header-right">
                <button class="btn btn-primary" ng-click="newInstance()" ng-disabled="isInstanceBeingCreated">
                    <i class="fas fa-plus"></i> {{newInstanceBtnText}}
                </button>
                <button class="btn btn-danger" ng-click="closeSession()">
                    <i class="fas fa-times"></i> Close Session
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="playground-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-section">
                    <h3>Instances</h3>
                    <div class="instance-list">
                        <div ng-repeat="instance in instances | orderBy:'hostname'" 
                             class="instance-item" 
                             ng-class="{active: instance.name == selectedInstance.name}" 
                             ng-click="showInstance(instance)">
                            <i class="fas fa-server"></i>
                            <span>{{instance.hostname}}</span>
                            <div class="instance-status">
                                <span class="status-indicator running"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-section" ng-if="selectedInstance">
                    <h3>Resources</h3>
                    <div class="resource-monitor">
                        <div class="resource">
                            <label>CPU</label>
                            <div class="progress-bar">
                                <div class="progress" ng-style="{width: selectedInstance.cpu + '%'}"></div>
                            </div>
                            <div class="resource-value">{{selectedInstance.cpu}}%</div>
                        </div>
                        <div class="resource">
                            <label>Memory</label>
                            <div class="progress-bar">
                                <div class="progress" ng-style="{width: selectedInstance.mem + '%'}"></div>
                            </div>
                            <div class="resource-value">{{selectedInstance.mem}}%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Terminal Area -->
            <div class="terminal-container">
                <div class="terminal-header" ng-if="selectedInstance">
                    <div class="terminal-tabs">
                        <div class="tab active">{{selectedInstance.name}}</div>
                    </div>
                    <div class="terminal-controls">
                        <button class="control-btn" title="Fullscreen">
                            <i class="fas fa-expand"></i>
                        </button>
                        <button class="control-btn" title="Settings">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Instance Details -->
                <div class="instance-details" ng-if="selectedInstance">
                    <div class="detail-row">
                        <div class="detail-item">
                            <label>IP Address</label>
                            <div class="value">{{selectedInstance.ip}}</div>
                        </div>
                        <div class="detail-item">
                            <label>Hostname</label>
                            <div class="value">{{selectedInstance.hostname}}</div>
                        </div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-item">
                            <label>Ports</label>
                            <div>
                                <span ng-repeat="port in selectedInstance.ports" class="port-chip">
                                    <a href="{{getProxyUrl(selectedInstance, port)}}" target="_blank">{{port}}</a>
                                </span>
                                <span ng-if="!selectedInstance.ports.length">No ports exposed</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-item">
                            <label>Direct URL</label>
                            <div class="value">{{selectedInstance.proxy_host}}.direct.{{host}}</div>
                        </div>
                    </div>
                    
                    <div class="detail-row">
                        <button class="btn btn-danger" ng-click="deleteInstance(selectedInstance)" ng-disabled="isInstanceBeingDeleted">
                            <i class="fas fa-trash"></i> {{deleteInstanceBtnText}}
                        </button>
                    </div>
                </div>
                
                <!-- Terminal -->
                <div class="terminal-body" ng-if="selectedInstance">
                    <div ng-show="uploadMessage" class="upload-status">
                        <div>{{uploadMessage}}</div>
                        <div style="margin-top: 5px;">
                            <div style="height: 4px; background: #4a5568; border-radius: 2px;">
                                <div style="height: 100%; background: #4fc3f7; border-radius: 2px;" ng-style="{width: uploadProgress + '%'}"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div ng-show="selectedInstance.status=='reconnect'" class="upload-status">
                        Connection has been lost. Trying to reconnect terminal...
                    </div>
                    
                    <div id="terminal-{{selectedInstance.name}}" style="height: 400px; width: 100%;"></div>
                </div>
                
                <div class="terminal-body" ng-if="!selectedInstance">
                    <p>No instance selected. Please add an instance to get started.</p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="playground-footer">
            <div class="footer-info">
                Kubernetes Playground - Session ID: {{sessionId}}
            </div>
            <div class="footer-actions">
                <button class="btn btn-outline">
                    <i class="fas fa-question-circle"></i> Help
                </button>
                <button class="btn btn-outline">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
        </div>
    </div>

    <!-- Connection Status Overlay -->
    <section ng-if="!connected" class="disconnected">
        <h1>No connection to server. Reconnecting...</h1>
        <div style="margin-top: 20px;">
            <i class="fas fa-sync fa-spin" style="font-size: 24px;"></i>
        </div>
    </section>

    <!-- Session Expired Message -->
    <section id="sessionEnd" ng-if="!isAlive" class="disconnected">
        <div>
            <h1>Your session has expired.</h1>
            <p style="margin-top: 10px;">All instances and data have been cleared.</p>
            <button class="btn btn-primary" style="margin-top: 20px;" onclick="window.location.reload()">
                <i class="fas fa-redo"></i> Start New Session
            </button>
        </div>
    </section>

    <!-- External Scripts -->
    <script src="https://unpkg.com/reconnectingwebsocket@1.0.0/reconnecting-websocket.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://unpkg.com/angular@1.5.5/angular.min.js"></script>
    <script src="https://unpkg.com/angular-animate@1.5.5/angular-animate.min.js"></script>
    <script src="https://unpkg.com/angular-aria@1.5.5/angular-aria.min.js"></script>
    <script src="https://unpkg.com/angular-messages@1.5.5/angular-messages.min.js"></script>
    <script src="https://unpkg.com/ng-file-upload@12.2.13/dist/ng-file-upload-all.min.js"></script>
    <script src="https://unpkg.com/xterm@4.19.0/lib/xterm.js"></script>
    <script src="https://unpkg.com/xterm-addon-fit@0.5.0/lib/xterm-addon-fit.js"></script>
    <script src="https://unpkg.com/moment@2.16.0/min/moment.min.js"></script>

    <!-- App Script -->
    <script>
        // Setup XTerm.js
        function setupXTerm() {
            Terminal.applyAddon(fit);
        }
        
        // Main App Script
        angular.module('DockerPlay', ['ngAnimate', 'ngAria', 'ngMessages', 'ngFileUpload'])
            .controller('PlayController', ['$scope', '$http', '$timeout', function($scope, $http, $timeout) {
                // Initialize variables
                $scope.instances = [
                    {name: 'node1', hostname: 'node1', ip: '192.168.1.10', cpu: 45, mem: 65, ports: [80, 443], proxy_host: 'node1'},
                    {name: 'node2', hostname: 'node2', ip: '192.168.1.11', cpu: 30, mem: 40, ports: [8080], proxy_host: 'node2'}
                ];
                $scope.selectedInstance = $scope.instances[0];
                $scope.isAlive = true;
                $scope.connected = true;
                $scope.isInstanceBeingCreated = false;
                $scope.isInstanceBeingDeleted = false;
                $scope.newInstanceBtnText = "Add Instance";
                $scope.deleteInstanceBtnText = "Delete Instance";
                $scope.ttl = "4";
                $scope.host = window.location.hostname;
                $scope.sessionId = Math.random().toString(36).substring(2, 10).toUpperCase();
                $scope.uploadMessage = null;
                $scope.uploadProgress = 0;
                
                // Initialize terminals object
                $scope.terminals = {};
                
                // Setup WebSocket connection
                const wsScheme = window.location.protocol === "https:" ? "wss:" : "ws:";
                const wsUri = wsScheme + "//" + window.location.host + "/ws";
                const socket = new ReconnectingWebSocket(wsUri);
                
                socket.onopen = function() {
                    console.log("WebSocket connection established");
                    $scope.connected = true;
                    $scope.$apply();
                };
                
                socket.onclose = function() {
                    console.log("WebSocket connection closed");
                    $scope.connected = false;
                    $scope.$apply();
                };
                
                // Function to create a new instance
                $scope.newInstance = function() {
                    $scope.isInstanceBeingCreated = true;
                    $scope.newInstanceBtnText = "Creating...";
                    
                    // Simulate instance creation
                    $timeout(function() {
                        const newInstance = {
                            name: 'node' + ($scope.instances.length + 1),
                            hostname: 'node' + ($scope.instances.length + 1),
                            ip: '192.168.1.' + (10 + $scope.instances.length),
                            cpu: Math.floor(Math.random() * 100),
                            mem: Math.floor(Math.random() * 100),
                            ports: [3000 + $scope.instances.length],
                            proxy_host: 'node' + ($scope.instances.length + 1)
                        };
                        
                        $scope.instances.push(newInstance);
                        $scope.isInstanceBeingCreated = false;
                        $scope.newInstanceBtnText = "Add Instance";
                        $scope.$apply();
                    }, 1500);
                };
                
                // Function to delete an instance
                $scope.deleteInstance = function(instance) {
                    $scope.isInstanceBeingDeleted = true;
                    $scope.deleteInstanceBtnText = "Deleting...";
                    
                    // Simulate instance deletion
                    $timeout(function() {
                        const index = $scope.instances.indexOf(instance);
                        if (index > -1) {
                            $scope.instances.splice(index, 1);
                        }
                        
                        if ($scope.selectedInstance === instance) {
                            $scope.selectedInstance = $scope.instances.length > 0 ? $scope.instances[0] : null;
                        }
                        
                        $scope.isInstanceBeingDeleted = false;
                        $scope.deleteInstanceBtnText = "Delete Instance";
                        $scope.$apply();
                    }, 1000);
                };
                
                // Function to show an instance
                $scope.showInstance = function(instance) {
                    $scope.selectedInstance = instance;
                };
                
                // Function to close the session
                $scope.closeSession = function() {
                    $scope.isAlive = false;
                };
                
                // Function to get proxy URL
                $scope.getProxyUrl = function(instance, port) {
                    return `http://${instance.proxy_host}.direct.${$scope.host}:${port}`;
                };
                
                // File upload handling
                $scope.uploadFiles = function(files, invalidFiles) {
                    if (files && files.length > 0 && $scope.selectedInstance) {
                        $scope.uploadMessage = "Uploading files...";
                        $scope.uploadProgress = 0;
                        
                        // Simulate file upload progress
                        const interval = setInterval(() => {
                            $scope.uploadProgress += 5;
                            if ($scope.uploadProgress >= 100) {
                                clearInterval(interval);
                                $scope.uploadMessage = "Files uploaded successfully!";
                                $timeout(() => {
                                    $scope.uploadMessage = null;
                                }, 3000);
                            }
                            $scope.$apply();
                        }, 100);
                    }
                };
                
                // Initialize
                setupXTerm();
            }]);
            
        // Handle beforeunload event
        window.onbeforeunload = function (e) {
            e = e || window.event;
            if (e) {
                e.returnValue = 'Make sure you saved your session URL';
            }
            return 'Make sure you saved your session URL';
        };
    </script>
</body>
</html>